```markdown
# MatchApprover

The **MatchApprover** module provides an interactive UI for reviewing and approving matches generated by a fuzzy matching system for scanned book spines. After running OCR and a matching step, you may end up with multiple possible titles or authors for a given book spine image. **MatchApprover** allows you to quickly iterate through images, inspect proposed matches above a certain confidence threshold, and approve the best match or skip if no suitable match is found.

By using **MatchApprover**, you ensure that the data downstream (like library catalogs or inventory lists) is accurate. The intuitive interface and keyboard-driven controls streamline the verification process, making it less time-consuming and more user-friendly.

## Core Features

- **Interactive Image-by-Image Review**

  - Displays images (either processed or raw) side-by-side with a sidebar listing the top matches above a user-defined threshold.

  - Quickly navigate through images and approve matches with a single keystroke.
  - Option to skip images when no acceptable match is found.

- **Confidence Thresholding and Sorting**

  Matches are displayed only if they exceed a specified confidence threshold. They are also sorted by confidence in descending order, ensuring you see the best candidates first.

- **User-Friendly Keyboard Commands**

  With simple keypresses, you can:
  
  - **Navigate Images** using `<` and `>`  

  - **Toggle View** between processed and raw images using `/`  
  - **Approve a Match** by pressing a digit corresponding to the chosen match  
  - **Skip an Image** by pressing `s` if none of the matches are appropriate  
  - **Quit** the interface with `q`

## Why `MatchApprover` and `poetry run match-approver`?

After extracting text from book spines and running a fuzzy matching algorithm against a database of known titles, you'll likely produce a `matcher.json` file. This JSON contains potential matches for each image, including titles, authors, and confidence scores.

**`MatchApprover`** (*implemented in `match_approver.py` and accessible via `poetry run match-approver`*) is the tool that allows you to refine this output set. Instead of blindly trusting the fuzzy matches, you can quickly confirm the correct matches or identify that none of the suggestions are suitable. This final validation step helps ensure the integrity and accuracy of your curated data.

## Getting Started

### Prerequisites

1. **Matcher Results Available**:  
   Before using `MatchApprover`, ensure that the `matcher.json` file (located at `data/results/matcher.json`) is populated with match results. This is typically generated by running the fuzzy matching step after OCR extraction.

2. **Images in Place**:  
   Make sure your processed images are in `images/processed` and original (raw) images are in `images/books`. `MatchApprover` relies on these directories to find the corresponding images.

### Launching the Interactive Approver

From within your project directory:

```bash
poetry run match-approver
```

This command:
- Loads the `matcher.json` results.
- Opens a GUI window with the first image and its top matches.
- Waits for your input to approve matches, skip, navigate, or switch between processed/raw views.

## Sidebar and Controls

Once the UI is open, youâ€™ll see:

- **Current Image**: Shows which image you are currently reviewing.

- **Matches**: A list of candidate matches above your threshold, each with a score.
  - Press the number key corresponding to a match to approve it.

- **Skip**: Press `s` if no match is correct for the current image.
- **Navigation**:
  - Use `>` or `<` to move between images.

  - Press `/` to toggle between processed (pre-processed/annotated) and raw images.
  - Press `q` to quit when done.

## Approvals and Outputs

As you make selections, `MatchApprover` builds a dictionary of approvals:

```json
{
  "0.jpg": {
    "title": "The Diary of a Young Girl",
    "author": "Anne Frank",
    "score": 0.8857
  },
  "1.jpg": null, 
  "2.jpg": {
    "title": "To Kill a Mockingbird",
    "author": "Harper Lee",
    "score": 0.92
  }
}
```

- If a match is chosen, it records the selected title, author, and confidence score.
- If skipped, the value is `null`.

When you quit (`q`), these approvals are saved to `data/results/approvals.json`. This record can then be used for subsequent tasks, like updating a catalog, training a model, or performing an inventory check.

## Example Usage in Python

You can also integrate `MatchApprover` directly into your Python code, though the primary mode is the CLI-based interactive approach:

```python
from bookshelf_scanner.approval_layer import MatchApprover

approver = MatchApprover(threshold = 0.9)
approver.run_interactive_mode()
```

This would launch the same interactive GUI, but gives you flexibility if you want to script around the approval process.